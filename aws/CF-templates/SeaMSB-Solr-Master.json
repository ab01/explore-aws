{
  "AWSTemplateFormatVersion": "2010-09-09",
        "Metadata" : {
		"CloudFormationScriptName" : "MSB Deployment",
		"CreatedBy" : "Ankit.Bhalla@Amway.com",
		"Purpose" : "Automate creation of MSB Hybris Solr environment buildout",
		"Components" : "1x EC2, 1 x Autoscaling Group",
		"ChangesPipeline" : "Nil"
	},
	
    "Parameters" : {
	
	  "MachineType" : {
		"Description" : "Select the amazon machine type you would like use for Ec2 instance",
		"Type" : "String",
		"Default" : "m4.large"
      },
	  
	  "KeyName" : {
		"Description" : "Select the Keypair name that you want to use for the Ec2 instances",
		"Type": "AWS::EC2::KeyPair::KeyName",
		"Default": "SeaUatMSBWebModernation"
      },
	  
	  "TimeZone" : {
		"Description" : "Enter the timzone that you would like to assign to the machine in the format eg. Asia/Tokyo",
        "Type" : "String",
		"Default" : "Asia/Singapore"
      },
	  
	    "EBSVolumeSize" : {
            "Default" : "15",
            "Description" : "The volume size, in gibibytes (GiB) that you want to assign to EBS. This can be a number from 1 - 1024.",
            "Type" : "String"
        },

	  "AmiIdValue" : {
		"Description" : "Base OS AMI you would like to choose for deployment",
		"Type": "AWS::EC2::Image::Id",
		"Default": "ami-a59b49c6"
      },
	  
	  "Application" : {
		"Description" : "Enter the name of the Application. Eg. AmwaySEA",
		"Type" : "String",
		"Default": "demo"
		
      },
	  
	   "SubApplication" : {
		"Description" : "Select the Package Directory whether you want to deploy  Seahybris  environment components or Solr  ",
         "Type" : "String",
		"Default": "Datahub",
		"AllowedValues": [
			"Solr",
			"Hybris",
			"Datahub",
			"APIProxy"
		]	
      },
	  
    "MinFleetSize" : {
		"Description" : "Minimum number of instances in the fleet",
		"Type" : "String",
		"Default" : "1",
		"ConstraintDescription" : "Keep atleast 1 as the value"
    },
	
    "MaxFleetSize" : {
		"Description" : "Maximum number of inubit instances in the fleet",
		"Type" : "String",
		"Default" : "1",
		"ConstraintDescription" : "Ideally you woudn't need more than 4"
    },
	
    "CoolDownPeriod" : {
		"Description" : "The number of seconds after a scaling activity is completed before any further scaling activities can start.",
		"Type" : "String",
		"Default" : "120",
		"ConstraintDescription" : "Give enough room for scaling activities."
    },	
	
	 "BucketName" : {
		"Description" : "S3 Bucket Name. Eg. s3://korinflocsourcerepo/",
		"Type" : "String",
		 "Default": "seamsbuatrepo"
      },
	
	  "BuildScriptPath" : {
		"Description" : "S3 Path of the build script to be executed during first boot. Eg. s3://seainflocsourcerepo/BuildScripts",
		"Type" : "String",
		 "Default": "s3://seainflocsourcerepo/BuildScripts"
      },
	  
	 
          "ENV" : {
		"Description" : "Name of the env to select for downloading packages from the buckets ",
         "Type" : "String",
		"Default": "Uat",
		"AllowedValues": [
			"Dev",
			"Uat",
			"Stg",
			"Tst",
			"Qa",
			"Prd"
		]	
      },
	  
	  
	    "Role" : {
            "Default" : "master",
            "Description" : "Select the Solr Role [ master or slave ]",
            "Type" : "String",
            "AllowedValues" : ["master","slave"]
        },
	
		
	  "Ec2TagValue" : {
		"Description" : "Name tag to be assigned to Ec2 instances node",
        "Type" : "String",
		 "Default": "msb-demo"	
      },
	  
	  "Ec2TagName" : {
		"Description" : "same as Ec2TagValue Name tag to be assigned to Ec2 instances node",
        "Type" : "String",
		 "Default": "msb-demo"
      },
	  
	  "Ec2TagContact" : {
		"Description" : "Contact email address of the person/group responsible for this application",
        "Type" : "String",
		 "Default": "msb-demo"
      },

	  "Ec2TagAmwayRegion" : {
  		"Description" : "Region tag you want to assign to the Ec2 instance",
        "Type" : "String",
		 "Default": "Malaysia"
		
      },
	  
	  "Ec2TagEnvironment" : {
  		"Description" : "Environment tag you want to assign to the Ec2 instance",
        "Type" : "String",
		"Default": "Prd",
		"AllowedValues": [
			"Dev",
			"Uat",
			"Stg",
			"Tst",
			"Prd"
		]
      },
	  
	  

	  "SubnetGroupSubnetIDs" : {
		"Description" : "Select the two Subnets where you would like to deploy the stack",
		"Type" : "List<AWS::EC2::Subnet::Id>",
		 "Default": "subnet-260d0e51,subnet-7d0d0718"
  	  },
	  
	  "ZONEID" : {
	    "Default" : "Z19S0V2CQ594WQ",
      "Type" : "String",
      "Description" : "Route53 DNS hosted ZoneID"
	  },
	  
	  	"RECORDSET" : {
		"Default" : "seahybrissolrmaster.preprod.sea.amway.net",
      "Type" : "String",
      "Description" : "The DNS name for application for record set"
     },
	 
	  "HostedZoneName" : {
		"Description" : "Enter the Route53 Zone name",
        "Type" : "String",
		 "Default": "preprod.sea.amway.net."
      },  
	 
	  "SNSArnId" : {
		"Description" : "Enter the ARN ID of the SNS Topic to which alerts needs to be sent in case of autoscaling errors. Eg. arn:aws:sns:ap-southeast-1:183887352813:APACRegionalArchitecture",
		"Type" : "String",
		"ConstraintDescription" : "If you don't have one, plesae ensure to create it beforehand.",
		"Default" : "arn:aws:sns:ap-southeast-1:183887352813:SeaQAMSBWebModernation"
		},

    "ScaleUpCPUThreshold" : {
		"Description" : "For ScaleUp Action : The CPU usage threshold for ScaleUp action",
		"Type" : "String",
		"Default" : "80",
		"ConstraintDescription" : "Plesae be careful and refer documentation before inserting the value."
    },
	
    "ScaleUpCheckPeriod" : {
		"Description" : "For ScaleUp - The number of seconds over which the CPU usage is sampled to take an average in order to compare with threshold",
		"Type" : "String",
		"Default" : "60",
		"ConstraintDescription" : "Plesae be careful and refer documentation before inserting the value."
    },
	
    "ScaleUpEvaluationPeriods" : {
		"Description" : "For ScaleUp Action - The number of periods over which the CPU usage is compared to the specified threshold ",
		"Type" : "String",
		"Default" : "5",
		"ConstraintDescription" : "Plesae be careful and refer documentation before inserting the value."
    },
	
    "ScaleDownCPUThreshold" : {
		"Description" : "For ScaleDown Action : The CPU usage threshold for ScaleDown action",
		"Type" : "String",
		"Default" : "20",
		"ConstraintDescription" : "Plesae be careful and refer documentation before inserting the value."
    },
	
    "ScaleDownCheckPeriod" : {
		"Description" : "For ScaleDown - The number of seconds over which the CPU usage is sampled to take an average in order to compare with threshold",
		"Type" : "String",
		"Default" : "300",
		"ConstraintDescription" : "Plesae be careful and refer documentation before inserting the value."
    },
	
    "ScaleDownEvaluationPeriods" : {
		"Description" : "For ScaleDown Action - The number of periods over which the CPU usage is compared to the specified threshold ",
		"Type" : "String",
		"Default" : "4",
		"ConstraintDescription" : "Plesae be careful and refer documentation before inserting the value."
    },
	
	
	  "VPCID" : {
	  	"Description" : "Select the VPC where you want deploy the Stack",
		"Type": "AWS::EC2::VPC::Id",
		 "Default": "vpc-a7075ec2"
      },
	  
	  "VpcName" : {
	  	"Description" : "Enter the name of the VPC where the system will be deployed",
		"Type" : "String",
		 "Default": "Apse1SeaPreprod01"
      },
	  
	  "TimeZone" : {
		"Description" : "Enter the timzone that you would like to assign to the machine in the format eg. Asia/Tokyo",
        "Type" : "String",
		 "Default": "Asia/Singapore"
      }
	  
    },	
	
 "Mappings": {
    "EnvironmentMapping": {
	   "AmwayLocation1": { "Value" : "0.0.0.0/0"},
	   "AmwayLocation2": { "Value" : "10.0.0.0/8"}
    }
  },
  
  "Resources": {
  	 
	
	"InstanceSecurityGroup" : {
		"Type" : "AWS::EC2::SecurityGroup",
		"Properties" : {
        "VpcId" : { "Ref" : "VPCID" },
		"Tags" : [ 
					{
						"Key" : "Name", 
						"Value" : { "Ref" : "Ec2TagValue" } 
					},
					
					{
						"Key" : "Environment", 
						"Value" : { "Ref" : "Ec2TagEnvironment" } 
					},
					
					{
						"Key" : "Application", 
						"Value" : { "Ref" : "Application" } 
					},						
					
					{
						"Key" : "Contact", 
						"Value" : { "Ref" : "Ec2TagContact" } 
					},										

					{
						"Key" : "SubApplication", 
						"Value" : { "Ref" : "SubApplication" } 
					},										

					{
						"Key": "FQN",
						"Value": {
							"Fn::Join" : [ "/", [
								{ "Ref":"AWS::AccountId" },
								{ "Ref" : "Ec2TagAmwayRegion" },
								{ "Ref" : "Ec2TagEnvironment" },
								{ "Ref" : "VpcName" },
								"Sg",
								"Private",
								{ "Ref" : "Application" },
								{ "Ref" : "SubApplication" },
								{ "Ref" : "Ec2TagValue" }
							]]
						}
					}
				],
        "GroupDescription" : "Enable SSH traffic from corporate network and traffic from ELB",
        "SecurityGroupIngress" : [
			 	{
				"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : {
					"Fn::FindInMap": [ "EnvironmentMapping", "AmwayLocation2", "Value" ]
				}	
			},
			
				{
				"IpProtocol" : "tcp", "FromPort" : "8983", "ToPort" : "8983", "CidrIp" : {
					"Fn::FindInMap": [ "EnvironmentMapping", "AmwayLocation2", "Value" ]
				}	
			}
          
        ]
      }
    },

      
   "Ec2InstanceRole": {
         "Type": "AWS::IAM::Role",
         "Properties": {
            "AssumeRolePolicyDocument": {
               "Version" : "2012-10-17",
               "Statement": [ {
                  "Effect": "Allow",
                  "Principal": {
                     "Service": [ "ec2.amazonaws.com" ]
                  },
                  "Action": [ "sts:AssumeRole" ]
               } ]
            },
            "Path": "/",
            "Policies": [ {
               "PolicyName": { "Ref" : "Ec2TagValue" },
               "PolicyDocument": {
                  "Version" : "2012-10-17",
                  "Statement": [ {
                     "Effect": "Allow",
                     "Action": [
								"s3:Get*",
								"s3:List*",
								"s3:Put*",
								"ec2:*",
								"logs:*",
								"autoscaling:*",
								"cloudwatch:*",
								"route53:*",
                                "sns:*"    
								],
                     "Resource": "*"
                  } ]
               }
               } ]
            }
      },
	  
	   "Ec2InstanceProfile": {
         "Type": "AWS::IAM::InstanceProfile",
         "Properties": {
            "Path": "/",
            "Roles": [ {
               "Ref": "Ec2InstanceRole"
            } ]
         }
      },
	  
	  
	
	
	"AutoScalingGroup": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
		"AvailabilityZones": { "Fn::GetAZs" : { "Ref" : "AWS::Region" } },
		"Cooldown": { "Ref" : "CoolDownPeriod" },
        "DesiredCapacity": { "Ref" : "MinFleetSize" },
        "MaxSize": { "Ref" : "MaxFleetSize" },
		"MinSize" : { "Ref" : "MinFleetSize" },
		"MetricsCollection" : [
			{
				"Granularity": "1Minute"
			}
		],
        "HealthCheckGracePeriod": "60",
        "HealthCheckType": "EC2",
        "VPCZoneIdentifier": { "Ref" : "SubnetGroupSubnetIDs" },
		"NotificationConfiguration": {
          "TopicARN": { "Ref" : "SNSArnId" },
          "NotificationTypes": [
            "autoscaling:EC2_INSTANCE_LAUNCH",
            "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
            "autoscaling:EC2_INSTANCE_TERMINATE",
            "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
          ]
        },
		"TerminationPolicies": [
			"OldestInstance"
		],
        "LaunchConfigurationName": { "Ref": "LaunchConfig" },
		
		
        "Tags": [ 
					{
						"Key" : "Name", 
						"Value" : { "Ref" : "Ec2TagValue" },
						"PropagateAtLaunch": true
					},
					
					{
						"Key" : "Contact", 
						"Value" : { "Ref" : "Ec2TagContact" },
						"PropagateAtLaunch": true
					},	
					
					{
						"Key" : "Environment", 
						"Value" : { "Ref" : "Ec2TagEnvironment" } ,
						"PropagateAtLaunch": true
					},
					
					{
						"Key" : "Application", 
						"Value" : { "Ref" : "Application" } ,
						"PropagateAtLaunch": true
					},										

					{
						"Key" : "SubApplication", 
						"Value" : { "Ref" : "SubApplication" } ,
						"PropagateAtLaunch": true
					},										

					{
						"Key": "FQN",
						"Value": {
							"Fn::Join" : [ "/", [
								{ "Ref":"AWS::AccountId" },
								{ "Ref" : "Ec2TagAmwayRegion" },
								{ "Ref" : "Ec2TagEnvironment" },
								{ "Ref" : "VpcName" },
								"AutoScaling",
								"Private",
								{ "Ref" : "Application" },
								{ "Ref" : "SubApplication" },
								{ "Ref" : "Ec2TagValue" }
							]]
						},
						"PropagateAtLaunch": true
					}
				]
      }
    },
	
	 
    "LaunchConfig": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
	
      "Properties": {
        "AssociatePublicIpAddress" : false,
		"ImageId": { "Ref" : "AmiIdValue" },
        "InstanceType": { "Ref" : "MachineType" },
		"SecurityGroups" : [ {"Ref" : "InstanceSecurityGroup"} ],
		"IamInstanceProfile" : {"Ref" : "Ec2InstanceProfile"} ,
        "KeyName": { "Ref" : "KeyName" },
        "InstanceMonitoring": true,
		"UserData": {
				 "Fn::Base64": {
					 "Fn::Join": [
					   "",
					   [
												"#!/bin/bash\n",	
                         "# Version: 1.0\n",	
                          "yum -y update\n",
						  "mkdir /usr/local/BuildFiles\n",
                          "yum update -y aws-cfn-bootstrap\n", 
                         "export VPCID=",{ "Ref" : "VPCID" },"\n",
					     "export AutoScalingGroup=","YES","\n",
						 "export ENV=",{ "Ref" : "ENV" },"\n",
					     "export S3Bucket=",{ "Ref" : "BucketName" },"\n",
						  "export BucketName=",{ "Ref" : "BucketName" },"\n",  
						  "export HostedZoneName=",{ "Ref" : "HostedZoneName" },"\n",
					     "export Ec2InstanceRole=",{ "Ref" : "Ec2InstanceRole" },"\n",
					    "export Ec2TagName=", { "Ref" : "Ec2TagName" },"\n",
						"export Ec2TagValue=", { "Ref" : "Ec2TagValue" },"\n",
						"export Role=", { "Ref" : "Role" },"\n",
						"export RECORDSET=", { "Ref" : "RECORDSET" },"\n",
						"export ZONEID=", { "Ref" : "ZONEID" },"\n",
					    "export BuildScriptPath=", { "Ref" : "BuildScriptPath" },"\n",
					    "export Environment=", { "Ref" : "Ec2TagEnvironment" },"\n",
					    "export APP=",{ "Ref" : "Application" },"\n",
					    "export SUBAPP=",{ "Ref" : "SubApplication" },"\n",
					    "export AWSRegion=",{ "Ref" : "AWS::Region" },"\n",
					  	"export TimeZone=",{ "Ref" : "TimeZone" },"\n",	
					    "export AmwayLocation1=",{"Fn::FindInMap": [ "EnvironmentMapping", "AmwayLocation1", "Value" ]},"\n",
					    "export AmwayLocation2=",{"Fn::FindInMap": [ "EnvironmentMapping", "AmwayLocation2", "Value" ]},"\n",
					    "export HTTPBuildPath=https://s3-$AWSRegion.amazonaws.com/$(echo $BuildScriptPath|cut -d/ -f3,4)\n",
					    "cd /usr/local/BuildFiles\n",
					     "/usr/bin/curl $HTTPBuildPath/",{"Fn::Join" : [ "/", [{ "Ref" : "Ec2TagEnvironment" },{ "Ref" : "Ec2TagName" },"Master.sh"]]},
					     " -O\n",					
					    "bash /usr/local/BuildFiles/Master.sh","\n",												
							"/opt/aws/bin/cfn-init -v  ",
                             "         -s ", { "Ref" : "AWS::StackId" },
                             "         --resource LaunchConfig ",
                             "         --region ", { "Ref" : "AWS::Region" }, "\n",
			                   "# All is well, so signal success.\n",
                              "/opt/aws/bin/cfn-signal -e 0 -r \"AWS CodeDeploy Agent setup complete.\" '",
							  { 
							  "Ref": "WaitHandle" 
							  },
							  "'\n"
					   ]
					]
				}
			},
		"BlockDeviceMappings": [
         {"DeviceName": "/dev/xvda","Ebs": { "VolumeSize" : { "Ref" : "EBSVolumeSize" } } }
        ]
      },
	  
	     "Metadata" : {
        "AWS::CloudFormation::Init" : {
          "config" : {
		    "packages" : {
			  "yum" : {
                 "unzip" : []
               }
			},			
			
            "files" : {
              "/etc/cfn/cfn-hup.conf" : {
                "content" : { "Fn::Join" : ["", [
                  "[main]\n",
                  "stack=", { "Ref" : "AWS::StackId" }, "\n",
                  "region=", { "Ref" : "AWS::Region" }, "\n"
                  ]]},
				  "mode"    : "000400",
                  "owner"   : "root",
                  "group"   : "root"
              },
              "/etc/cfn/hooks.d/cfn-auto-reloader.conf" : {
                "content": { "Fn::Join" : ["", [
                  "[cfn-auto-reloader-hook]\n",
                  "triggers=post.update\n",
                  "path=Resources.LaunchConfig.Metadata.AWS::CloudFormation::Init\n",
                  "action=/opt/aws/bin/cfn-init -v -s ", { "Ref" : "AWS::StackId" },
                      " -r LaunchConfig",
                      " --region ", { "Ref" : "AWS::Region" }, "\n",
					  "runas=root\n"
                ]]}
              }
            },
		
            "services" : {
              "sysvinit" : {
                "cfn-hup" : {
                  "enabled" : "true",
                  "ensureRunning" : "true",
                  "files" : ["/etc/cfn/cfn-hup.conf", "/etc/cfn/hooks.d/cfn-auto-reloader.conf"]
                }
              }
            }
          }
        },
		"AWS::CloudFormation::Authentication": {
        "rolebased" : {
        "type": "S3",
        "buckets": [ "seamsbuatrepo" ],
        "roleName": { "Ref": "Ec2InstanceRole" }
         }
        }
      }
    },
	
	"WaitHandle" : {
     "Type" : "AWS::CloudFormation::WaitConditionHandle"
   },
   
   "WaitCondition" : {
     "Type" : "AWS::CloudFormation::WaitCondition",
     "DependsOn" : "AutoScalingGroup",	
     "Properties" : {
         "Handle" : { "Ref" : "WaitHandle" },
		 "Timeout" : "1500"
       }
	   },
	
	
    "ScalingDecreaseGroupSize": {
      "Type": "AWS::AutoScaling::ScalingPolicy",
      "Properties": {
        "AdjustmentType": "ChangeInCapacity",
        "Cooldown": "300",
        "ScalingAdjustment": "-1",
        "AutoScalingGroupName": {
          "Ref": "AutoScalingGroup"
        }
      }
    },
	
    "ScalingIncreaseGroupSize": {
      "Type": "AWS::AutoScaling::ScalingPolicy",
      "Properties": {
        "AdjustmentType": "ChangeInCapacity",
        "Cooldown": "60",
        "ScalingAdjustment": "1",
        "AutoScalingGroupName": {
          "Ref": "AutoScalingGroup"
        }
      }
    }
	
	  
  },
  "Outputs" : {
		
		
 "AutoScalingGroup" : {
    "Description" : "Auto Scaling Group Reference ID",
    "Value" : { "Ref" : "AutoScalingGroup" }
  }
  

	
  },
  "Description": "MSB Deployment Cloudformation Template for Solr Master"
}